Once your base includes production structures, your bot's focus shifts to converting resources into military power. The commands for training units (`.train()`) and researching upgrades (`.research()`) are simple **Commands**. They are non-blocking and should be called directly without `await`.

However, to use them effectively, your bot must follow a complete, five-step validation lifecycle to ensure every production request is possible, non-redundant, and technologically feasible.

#### **The Complete Production Lifecycle**

A robust production system must validate a request against all five of these conditions before issuing a command.

```
(You want to produce something...)
           |
           v
.---  1. IS IT POSSIBLE? (Economic Check) ---.
| - self.can_afford()                      |
| - self.supply_left > 0                   | (For units)
`------------------------------------------`
           | (Yes)
           v
.--- 2. IS IT REDUNDANT? (State Check) ---.
| - self.already_pending() == 0          |
| - upgrade not in self.state.upgrades   | (For upgrades)
`--------------------------------------`
           | (No)
           v
.--- 3. DO I HAVE THE TECH? (Requirement Check) ---.
| - self.tech_requirement_progress(ITEM) == 1.0  |  <-- THE CRITICAL STEP
`------------------------------------------------`
           | (Yes)
           v
.--- 4. WHERE CAN I MAKE IT? (Building Check) ---.
| - building = self.structures(TYPE).ready.idle.first |
`-----------------------------------------------`
           | (Building exists)
           v
.---- 5. ISSUE COMMAND ----.
| - building.train(UNIT)  |
| - building.research(UPGRADE) |
`-----------------------`
```

---

#### **Deep Dive 1- Tracking Completed Upgrades with `self.state.upgrades`**

This property is used in **Step 2 (Redundancy Check)**.

*   **What it is:** `self.state.upgrades` is a Python `set` that contains the `UpgradeId` of every upgrade your bot has successfully completed.
*   **The Check:** `upgrade_id not in self.state.upgrades` is a highly efficient boolean check that returns `True` if you do not yet have the upgrade.

#### **Deep Dive 2- Verifying Tech with `self.tech_requirement_progress()`**

This function is used in **Step 3 (Tech Requirement Check)** and is essential for preventing your bot from getting stuck.

*   **What it is:** `self.tech_requirement_progress(item_id)` is a query that asks, "What percentage (from 0.0 to 1.0) of the tech requirements for this unit or upgrade have I met?"
*   **How it works:** It takes a `UnitTypeId` or `UpgradeId` and returns `1.0` only if you have all the necessary prerequisite buildings. For example, to train a Marauder, you need a Barracks with a Tech Lab attached. If you only have the Barracks, the progress will be less than `1.0`.
*   **The Check:** You must verify `self.tech_requirement_progress(item_id) == 1.0` before attempting to produce any unit or upgrade that has a dependency.

---

#### **Code Example- The Quartermaster Bot (Corrected and Robust)**


```python
# quartermaster_bot_final.py

from sc2 import maps
from sc2.bot_ai import BotAI
from sc2.data import Difficulty, Race
from sc2.main import run_game
from sc2.player import Bot, Computer
from sc2.ids.unit_typeid import UnitTypeId
from sc2.ids.upgrade_id import UpgradeId
from sc2.ids.ability_id import AbilityId

class QuartermasterBot(BotAI):
    """
    A bot that correctly manages production using the full 5-step lifecycle.
    """
    async def on_step(self, iteration: int):
        if not self.townhalls:
            return

        await self.distribute_workers()
        self.manage_production()
        await self.build_infrastructure()

    def manage_production(self):
        """A single manager for all production decisions."""
        # Worker Production
        if self.can_afford(UnitTypeId.SCV) and self.townhalls.ready.idle and self.workers.amount < 44:
            self.townhalls.ready.idle.first.train(UnitTypeId.SCV)

        # Army Production (Marauders)
        for barracks in self.structures(UnitTypeId.BARRACKS).ready.idle:
            # STEP 3: Check Tech Requirement
            if self.tech_requirement_progress(UnitTypeId.MARAUDER) == 1.0:
                # Steps 1 & 2: Check affordability and redundancy
                if self.can_afford(UnitTypeId.MARAUDER) and self.already_pending(UnitTypeId.MARAUDER) < 2:
                    # Step 5: Issue Command
                    barracks.train(UnitTypeId.MARAUDER)

        # Research
        self.manage_research()

    def manage_research(self):
        """Researches infantry upgrades in order."""
        eng_bay = self.structures(UnitTypeId.ENGINEERINGBAY).ready.idle.first
        if not eng_bay:
            return
            
        # STEP 3: Tech requirement for Level 2 is having an Armory.
        if self.tech_requirement_progress(UpgradeId.TERRANINFANTRYWEAPONSLEVEL2) == 1.0:
            if self.can_afford(UpgradeId.TERRANINFANTRYWEAPONSLEVEL2) and not self.already_pending_upgrade(UpgradeId.TERRANINFANTRYWEAPONSLEVEL2):
                eng_bay.research(UpgradeId.TERRANINFANTRYWEAPONSLEVEL2)
        elif self.can_afford(UpgradeId.TERRANINFANTRYWEAPONSLEVEL1) and not self.already_pending_upgrade(UpgradeId.TERRANINFANTRYWEAPONSLEVEL1) and UpgradeId.TERRANINFANTRYWEAPONSLEVEL1 not in self.state.upgrades:
            eng_bay.research(UpgradeId.TERRANINFANTRYWEAPONSLEVEL1)

    async def build_infrastructure(self):
        """Builds all necessary structures and add-ons."""
        # Build Depots
        if self.supply_left < 5 and not self.already_pending(UnitTypeId.SUPPLYDEPOT):
            if self.can_afford(UnitTypeId.SUPPLYDEPOT):
                await self.build(UnitTypeId.SUPPLYDEPOT, near=self.start_location.towards(self.game_info.map_center, 5))

        # Build Barracks
        if self.structures(UnitTypeId.SUPPLYDEPOT).ready.exists and self.structures(UnitTypeId.BARRACKS).amount < 2:
            if self.can_afford(UnitTypeId.BARRACKS):
                await self.build(UnitTypeId.BARRACKS, near=self.start_location.towards(self.game_info.map_center, 8))

        # Build Tech Labs on Barracks for Marauders
        for barracks in self.structures(UnitTypeId.BARRACKS).ready.idle:
            # Check if there's no add-on and we can afford a Tech Lab
            if not barracks.has_add_on and self.can_afford(UnitTypeId.TECHLAB):
                barracks(AbilityId.BUILD_TECHLAB)
                
        # Build Engineering Bay
        if self.structures(UnitTypeId.BARRACKS).ready and not self.structures(UnitTypeId.ENGINEERINGBAY):
            if self.can_afford(UnitTypeId.ENGINEERINGBAY):
                await self.build(UnitTypeId.ENGINEERINGBAY, near=self.start_location.towards(self.game_info.map_center, 10))
        
        # Build Armory (tech requirement for Level 2 upgrades)
        if self.structures(UnitTypeId.ENGINEERINGBAY).ready and not self.structures(UnitTypeId.ARMORY):
             if self.can_afford(UnitTypeId.ARMORY):
                await self.build(UnitTypeId.ARMORY, near=self.start_location.towards(self.game_info.map_center, 12))


if __name__ == "__main__":
    run_game(
        maps.get("AbyssalReefLE"),
        [Bot(Race.Terran, QuartermasterBot()), Computer(Race.Zerg, Difficulty.Easy)],
        realtime=True,
    )
```